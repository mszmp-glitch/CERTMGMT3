import { useState, useMemo } from "react";

const REASONS = ["Resale","Manufacturing","Agricultural","Government Entity","Non-Profit / Charitable","Industrial Processing","Direct Pay Permit","Foreign Diplomat","Tribal","Other"];
const ALLST = ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"];
const CTYPES = ["Blanket","Single Purchase"];

const seed = [
  {id:"EX-001",customer:"Acme Manufacturing Co.",ein:"12-3456789",email:"tax@acmemfg.com",type:"Blanket",reason:"Manufacturing",states:["TX","CA","NY"],issueDate:"2024-03-15",expDate:"2025-03-15",notes:"Annual renewal needed",renewalSent:false},
  {id:"EX-002",customer:"State of Texas - Dept of Transportation",ein:"74-6000000",email:"procurement@txdot.gov",type:"Blanket",reason:"Government Entity",states:["TX"],issueDate:"2025-01-10",expDate:"2027-01-10",notes:"",renewalSent:false},
  {id:"EX-003",customer:"GreenFields Agricultural LLC",ein:"45-6789012",email:"admin@greenfieldsag.com",type:"Blanket",reason:"Agricultural",states:["IA","NE","KS"],issueDate:"2024-11-01",expDate:"2025-11-01",notes:"",renewalSent:false},
  {id:"EX-004",customer:"ResellerHub Inc.",ein:"98-7654321",email:"compliance@resellerhub.com",type:"Blanket",reason:"Resale",states:["FL","GA"],issueDate:"2024-06-20",expDate:"2025-06-20",notes:"Renewal notice sent",renewalSent:true},
  {id:"EX-005",customer:"Hope Foundation",ein:"33-4455667",email:"finance@hopefoundation.org",type:"Single Purchase",reason:"Non-Profit / Charitable",states:["NY"],issueDate:"2025-02-01",expDate:"2026-02-01",notes:"501(c)(3) verified",renewalSent:false},
  {id:"EX-006",customer:"TechBuild Solutions",ein:"55-1234567",email:"ap@techbuild.io",type:"Blanket",reason:"Resale",states:["WA","OR","CA"],issueDate:"2024-08-12",expDate:"2025-05-12",notes:"",renewalSent:false},
  {id:"EX-007",customer:"Midwest Processing Inc.",ein:"22-9876543",email:"tax@midwestprocessing.com",type:"Blanket",reason:"Industrial Processing",states:["OH","IN","MI"],issueDate:"2023-12-01",expDate:"2024-12-01",notes:"Attempted contact 3x",renewalSent:true},
];

function gSt(d) {
  var diff = (new Date(d) - new Date()) / 86400000;
  if (diff < 0) return "expired";
  if (diff < 90) return "expiring_soon";
  return "valid";
}

function daysUntil(d) {
  return Math.ceil((new Date(d) - new Date()) / 86400000);
}

function validateForm(f) {
  var e = {};
  if (!f.customer.trim()) e.customer = "Customer name required";
  if (!/^\d{2}-\d{7}$/.test(f.ein)) e.ein = "Format: XX-XXXXXXX";
  if (f.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(f.email)) e.email = "Invalid email format";
  if (!f.states.length) e.states = "Select at least one state";
  if (!f.issueDate) e.issueDate = "Required";
  if (!f.expDate) e.expDate = "Required";
  if (f.issueDate && f.expDate && f.expDate <= f.issueDate) e.expDate = "Must be after issue date";
  return e;
}

function Badge(props) {
  var status = props.status;
  var m = {
    valid: {c:"#0d9488",bg:"#ccfbf1",l:"Valid"},
    expiring_soon: {c:"#d97706",bg:"#fef3c7",l:"Expiring Soon"},
    expired: {c:"#dc2626",bg:"#fee2e2",l:"Expired"}
  };
  var v = m[status] || {c:"#6b7280",bg:"#f3f4f6",l:status};
  return React.createElement("span", {style:{display:"inline-flex",alignItems:"center",gap:4,padding:"3px 10px",borderRadius:16,fontSize:12,fontWeight:600,color:v.c,background:v.bg}}, v.l);
}

var S = {
  wrap:{minHeight:"100vh",background:"#f8fafc",color:"#1e293b",fontFamily:"system-ui,-apple-system,sans-serif"},
  hdr:{background:"#fff",borderBottom:"1px solid #e2e8f0",padding:"16px 24px"},
  hdrIn:{maxWidth:1100,margin:"0 auto",display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:12},
  logo:{display:"flex",alignItems:"center",gap:10},
  logoIc:{width:40,height:40,borderRadius:12,background:"linear-gradient(135deg,#6366f1,#8b5cf6)",display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontWeight:800,fontSize:16},
  btn:{display:"inline-flex",alignItems:"center",gap:6,padding:"9px 16px",borderRadius:10,fontSize:13,fontWeight:600,border:"none",cursor:"pointer"},
  btnP:{background:"#4f46e5",color:"#fff"},
  btnS:{background:"#fff",border:"1px solid #e2e8f0",color:"#475569"},
  btnD:{background:"#fef2f2",color:"#dc2626",border:"1px solid #fecaca"},
  btnG:{background:"#f0fdf4",color:"#16a34a",border:"1px solid #bbf7d0"},
  main:{maxWidth:1100,margin:"0 auto",padding:24},
  row4:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))",gap:12,marginBottom:24},
  card:{background:"#fff",border:"1px solid #e2e8f0",borderRadius:14,padding:18},
  cardIc:{width:32,height:32,borderRadius:8,display:"flex",alignItems:"center",justifyContent:"center",color:"#fff",fontWeight:700,fontSize:13,marginBottom:8},
  cardV:{fontSize:26,fontWeight:800},
  cardL:{fontSize:11,color:"#94a3b8",textTransform:"uppercase",letterSpacing:1,marginTop:4,fontWeight:600},
  alert:{borderRadius:12,padding:14,display:"flex",gap:10,marginBottom:10,fontSize:13},
  alertA:{background:"#fffbeb",border:"1px solid #fde68a",color:"#92400e"},
  alertR:{background:"#fef2f2",border:"1px solid #fecaca",color:"#991b1b",marginBottom:16},
  alertB:{background:"#eff6ff",border:"1px solid #bfdbfe",color:"#1e40af",marginBottom:24},
  toolbar:{display:"flex",gap:12,marginBottom:20,flexWrap:"wrap"},
  searchW:{flex:1,minWidth:200},
  searchI:{width:"100%",background:"#fff",border:"1px solid #e2e8f0",borderRadius:10,padding:"9px 14px",fontSize:14,outline:"none",color:"#1e293b"},
  fGroup:{display:"flex",gap:3,background:"#fff",border:"1px solid #e2e8f0",borderRadius:10,padding:3},
  fBtn:{padding:"6px 14px",borderRadius:8,fontSize:12,fontWeight:600,border:"none",color:"#94a3b8",background:"transparent",cursor:"pointer"},
  fBtnOn:{background:"#4f46e5",color:"#fff"},
  tblW:{background:"#fff",border:"1px solid #e2e8f0",borderRadius:14,overflow:"hidden"},
  th:{padding:"12px 18px",textAlign:"left",fontSize:11,fontWeight:700,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5,borderBottom:"1px solid #e2e8f0"},
  td:{padding:"12px 18px",borderBottom:"1px solid #f1f5f9",verticalAlign:"middle"},
  tFoot:{padding:"10px 18px",borderTop:"1px solid #e2e8f0",fontSize:12,color:"#94a3b8"},
  stg:{display:"inline-block",background:"#f1f5f9",color:"#64748b",fontSize:11,padding:"2px 6px",borderRadius:4,margin:1},
  aBtn:{background:"none",border:"none",padding:"4px 8px",fontSize:13,color:"#64748b",borderRadius:6,cursor:"pointer",fontWeight:500},
  ov:{position:"fixed",inset:0,background:"rgba(0,0,0,.4)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100,padding:16},
  mdl:{background:"#fff",border:"1px solid #e2e8f0",borderRadius:16,width:"100%",maxHeight:"90vh",overflowY:"auto",padding:24},
  mdlS:{maxWidth:520},
  mdlL:{maxWidth:660},
  mdlH:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:18},
  mdlT:{fontSize:18,fontWeight:700},
  xb:{background:"none",border:"none",color:"#94a3b8",fontSize:20,cursor:"pointer",padding:"2px 6px"},
  fgr:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14,marginBottom:14},
  fld:{display:"flex",flexDirection:"column",gap:5},
  fla:{fontSize:11,fontWeight:600,color:"#94a3b8",textTransform:"uppercase",letterSpacing:0.5},
  fin:{background:"#fff",border:"1px solid #e2e8f0",borderRadius:10,padding:"9px 14px",color:"#1e293b",fontSize:14,outline:"none",width:"100%",fontFamily:"inherit"},
  finEr:{borderColor:"#f87171"},
  fer:{color:"#ef4444",fontSize:12},
  sgr:{display:"flex",flexWrap:"wrap",gap:5,padding:10,background:"#f8fafc",border:"1px solid #e2e8f0",borderRadius:10,maxHeight:110,overflowY:"auto"},
  sb:{padding:"3px 9px",borderRadius:7,fontSize:12,fontWeight:600,border:"none",color:"#94a3b8",background:"#e2e8f0",cursor:"pointer"},
  sbOn:{background:"#4f46e5",color:"#fff"},
  dgr:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,margin:"14px 0",fontSize:14},
  dgl:{color:"#94a3b8"},
  dgv:{color:"#1e293b",marginLeft:4},
  dst:{display:"inline-block",background:"#ede9fe",color:"#6d28d9",fontSize:12,padding:"3px 8px",borderRadius:7,margin:2},
  empty:{padding:40,textAlign:"center",color:"#94a3b8",fontSize:14},
  sentBadge:{display:"inline-flex",alignItems:"center",gap:4,padding:"2px 8px",borderRadius:10,fontSize:11,fontWeight:600,color:"#16a34a",background:"#f0fdf4",border:"1px solid #bbf7d0"},
  pendBadge:{display:"inline-flex",alignItems:"center",gap:4,padding:"2px 8px",borderRadius:10,fontSize:11,fontWeight:600,color:"#d97706",background:"#fffbeb",border:"1px solid #fde68a"},
};

export default function App() {
  var _s = useState(seed); var certs = _s[0]; var setCerts = _s[1];
  var _q = useState(""); var sQ = _q[0]; var setSQ = _q[1];
  var _f = useState("all"); var sF = _f[0]; var setSF = _f[1];
  var _m = useState(""); var modal = _m[0]; var setModal = _m[1];
  var _e = useState(null); var eId = _e[0]; var setEId = _e[1];
  var _frm = useState({customer:"",ein:"",email:"",type:"Blanket",reason:"Resale",states:[],issueDate:"",expDate:"",notes:""}); var frm = _frm[0]; var setFrm = _frm[1];
  var _fe = useState({}); var fErr = _fe[0]; var setFErr = _fe[1];
  var _vc = useState(null); var vCert = _vc[0]; var setVCert = _vc[1];
  var _nx = useState(8); var nxId = _nx[0]; var setNxId = _nx[1];
  var _toast = useState(null); var toast = _toast[0]; var setToast = _toast[1];
  var _renewModal = useState(null); var renewModal = _renewModal[0]; var setRenewModal = _renewModal[1];

  var enriched = useMemo(function() {
    return certs.map(function(c) { return Object.assign({}, c, {status: gSt(c.expDate), daysLeft: daysUntil(c.expDate)}); });
  }, [certs]);

  var stats = useMemo(function() {
    var v=0, e=0, x=0, rn=0;
    enriched.forEach(function(c) {
      if (c.status==="valid") v++;
      else if (c.status==="expiring_soon") { e++; if (!c.renewalSent) rn++; }
      else x++;
    });
    return {total:enriched.length, valid:v, expiring:e, expired:x, renewalNeeded:rn};
  }, [enriched]);

  var filtered = useMemo(function() {
    var q = sQ.toLowerCase();
    return enriched.filter(function(c) {
      var ms = !sQ || c.customer.toLowerCase().indexOf(q)>=0 || c.ein.indexOf(q)>=0 || c.id.toLowerCase().indexOf(q)>=0 || (c.email && c.email.toLowerCase().indexOf(q)>=0);
      var mf = sF==="all" || c.status===sF;
      return ms && mf;
    });
  }, [enriched, sQ, sF]);

  function showToast(msg) {
    setToast(msg);
    setTimeout(function() { setToast(null); }, 3500);
  }

  function openNew() {
    setFrm({customer:"",ein:"",email:"",type:"Blanket",reason:"Resale",states:[],issueDate:"",expDate:"",notes:""});
    setFErr({}); setEId(null); setModal("form");
  }
  function openEdit(c) {
    setFrm({customer:c.customer,ein:c.ein,email:c.email||"",type:c.type,reason:c.reason,states:c.states.slice(),issueDate:c.issueDate,expDate:c.expDate,notes:c.notes});
    setFErr({}); setEId(c.id); setVCert(null); setModal("form");
  }
  function closeAll() { setModal(""); setVCert(null); setRenewModal(null); }
  function doDelete(id) { setCerts(function(p) { return p.filter(function(c) { return c.id!==id; }); }); setVCert(null); }
  function toggleSt(st) {
    setFrm(function(f) {
      var idx = f.states.indexOf(st);
      var ns = f.states.slice();
      if (idx>=0) ns.splice(idx,1); else ns.push(st);
      return Object.assign({}, f, {states: ns});
    });
  }
  function updFld(k, v) { setFrm(function(f) { var o = {}; o[k]=v; return Object.assign({}, f, o); }); }
  function doSubmit() {
    var errs = validateForm(frm);
    setFErr(errs);
    if (Object.keys(errs).length) return;
    if (eId) {
      setCerts(function(p) { return p.map(function(c) { return c.id===eId ? Object.assign({}, c, frm) : c; }); });
    } else {
      var pad = String(nxId).padStart(3,"0");
      setNxId(function(n) { return n+1; });
      setCerts(function(p) { return [Object.assign({id:"EX-"+pad, renewalSent:false}, frm)].concat(p); });
    }
    closeAll();
  }

  function sendRenewal(cert) {
    if (!cert.email) {
      setRenewModal(cert);
      return;
    }
    setCerts(function(p) { return p.map(function(c) { return c.id===cert.id ? Object.assign({}, c, {renewalSent:true}) : c; }); });
    showToast("Renewal request sent to " + cert.email);
  }

  function sendAllRenewals() {
    var sent = 0;
    setCerts(function(p) {
      return p.map(function(c) {
        var st = gSt(c.expDate);
        if (st === "expiring_soon" && !c.renewalSent && c.email) {
          sent++;
          return Object.assign({}, c, {renewalSent: true});
        }
        return c;
      });
    });
    showToast("Sent " + (sent || "0") + " renewal request" + (sent !== 1 ? "s" : ""));
  }

  function generateMailto(cert) {
    var subj = encodeURIComponent("Exemption Certificate Renewal Request - " + cert.customer);
    var body = encodeURIComponent(
      "Dear " + cert.customer + ",\n\n" +
      "Our records indicate that your tax exemption certificate (" + cert.id + ") " +
      "for the following jurisdictions is " +
      (cert.daysLeft < 0 ? "expired" : "expiring in " + cert.daysLeft + " days") + ":\n\n" +
      "  Jurisdictions: " + cert.states.join(", ") + "\n" +
      "  Exemption Reason: " + cert.reason + "\n" +
      "  Certificate Type: " + cert.type + "\n" +
      "  Expiration Date: " + cert.expDate + "\n\n" +
      "To continue receiving tax-exempt treatment on your purchases, please provide an updated exemption certificate at your earliest convenience.\n\n" +
      "If your exemption status has changed or you have any questions, please don't hesitate to reach out.\n\n" +
      "Thank you for your prompt attention to this matter.\n\n" +
      "Best regards"
    );
    return "mailto:" + (cert.email || "") + "?subject=" + subj + "&body=" + body;
  }

  var statData = [
    {bg:"#64748b",val:stats.total,label:"Total"},
    {bg:"#059669",val:stats.valid,label:"Valid"},
    {bg:"#d97706",val:stats.expiring,label:"Expiring (<90d)"},
    {bg:"#dc2626",val:stats.expired,label:"Expired"},
    {bg:"#4f46e5",val:stats.renewalNeeded,label:"Needs Outreach"}
  ];

  var filterOpts = [
    {v:"all",l:"All"},{v:"valid",l:"Valid"},{v:"expiring_soon",l:"Expiring"},{v:"expired",l:"Expired"}
  ];

  return (
    <div style={S.wrap}>
      {/* Toast */}
      {toast && (
        <div style={{position:"fixed",top:20,right:20,zIndex:200,background:"#065f46",color:"#d1fae5",padding:"12px 20px",borderRadius:12,fontSize:14,fontWeight:600,boxShadow:"0 8px 30px rgba(0,0,0,.15)",display:"flex",alignItems:"center",gap:8,animation:"slideIn .3s ease"}}>
          <span style={{fontSize:16}}>&#10003;</span> {toast}
        </div>
      )}

      {/* Renewal preview modal */}
      {renewModal && (
        <div style={S.ov} onClick={function() { setRenewModal(null); }}>
          <div style={Object.assign({}, S.mdl, {maxWidth:460})} onClick={function(e) { e.stopPropagation(); }}>
            <div style={S.mdlH}>
              <div style={S.mdlT}>No Email on File</div>
              <button style={S.xb} onClick={function() { setRenewModal(null); }}>x</button>
            </div>
            <p style={{fontSize:14,color:"#475569",marginBottom:16}}>
              <b>{renewModal.customer}</b> does not have an email address on file. Please edit the certificate to add an email before sending a renewal request.
            </p>
            <div style={{display:"flex",gap:8}}>
              <button style={Object.assign({}, S.btn, S.btnP, {flex:1,justifyContent:"center"})} onClick={function() { setRenewModal(null); openEdit(renewModal); }}>Add Email</button>
              <button style={Object.assign({}, S.btn, S.btnS)} onClick={function() { setRenewModal(null); }}>Cancel</button>
            </div>
          </div>
        </div>
      )}

      <div style={S.hdr}>
        <div style={S.hdrIn}>
          <div style={S.logo}>
            <div style={S.logoIc}>CG</div>
            <div>
              <div style={{fontSize:18,fontWeight:800}}>CertGuard</div>
              <div style={{fontSize:12,color:"#94a3b8"}}>Exemption Certificate Manager</div>
            </div>
          </div>
          <div style={{display:"flex",gap:8}}>
            <button style={Object.assign({}, S.btn, S.btnS)} onClick={function() { setCerts(certs.slice()); }}>Revalidate</button>
            {stats.renewalNeeded > 0 && (
              <button style={Object.assign({}, S.btn, S.btnG)} onClick={sendAllRenewals}>
                Send All Renewals ({stats.renewalNeeded})
              </button>
            )}
            <button style={Object.assign({}, S.btn, S.btnP)} onClick={openNew}>+ New Certificate</button>
          </div>
        </div>
      </div>

      <div style={S.main}>
        {/* Stats */}
        <div style={S.row4}>
          {statData.map(function(d, i) {
            return (
              <div key={i} style={S.card}>
                <div style={Object.assign({}, S.cardIc, {background:d.bg})}>{d.label.charAt(0)}</div>
                <div style={S.cardV}>{d.val}</div>
                <div style={S.cardL}>{d.label}</div>
              </div>
            );
          })}
        </div>

        {/* Alerts */}
        {stats.renewalNeeded > 0 && (
          <div style={Object.assign({}, S.alert, S.alertB)}>
            <div>
              <b>{stats.renewalNeeded} certificate{stats.renewalNeeded > 1 ? "s" : ""} need proactive renewal outreach</b>
              <div style={{fontSize:12,opacity:0.7,marginTop:2}}>These certificates expire within 90 days and no renewal request has been sent yet.</div>
            </div>
          </div>
        )}
        {stats.expiring > 0 && (
          <div style={Object.assign({}, S.alert, S.alertA)}>
            <div>
              <b>{stats.expiring} certificate{stats.expiring > 1 ? "s" : ""} expiring within 90 days</b>
              <div style={{fontSize:12,opacity:0.7,marginTop:2}}>Send renewal requests to avoid lapsed exemptions and unexpected tax liability.</div>
            </div>
          </div>
        )}
        {stats.expired > 0 && (
          <div style={Object.assign({}, S.alert, S.alertR)}>
            <div>
              <b>{stats.expired} expired certificate{stats.expired > 1 ? "s" : ""} - action required</b>
              <div style={{fontSize:12,opacity:0.7,marginTop:2}}>Tax transactions until valid certificates are on file.</div>
            </div>
          </div>
        )}

        {/* Toolbar */}
        <div style={S.toolbar}>
          <div style={S.searchW}>
            <input style={S.searchI} placeholder="Search by customer, EIN, email, or ID..." value={sQ} onChange={function(e) { setSQ(e.target.value); }} />
          </div>
          <div style={S.fGroup}>
            {filterOpts.map(function(f) {
              return <button key={f.v} style={Object.assign({}, S.fBtn, sF===f.v ? S.fBtnOn : {})} onClick={function() { setSF(f.v); }}>{f.l}</button>;
            })}
          </div>
        </div>

        {/* Table */}
        <div style={S.tblW}>
          <div style={{overflowX:"auto"}}>
            <table style={{width:"100%",borderCollapse:"collapse"}}>
              <thead>
                <tr>
                  <th style={S.th}>Customer</th>
                  <th style={S.th}>Type / Reason</th>
                  <th style={S.th}>Jurisdictions</th>
                  <th style={S.th}>Expires</th>
                  <th style={S.th}>Status</th>
                  <th style={S.th}>Renewal</th>
                  <th style={Object.assign({}, S.th, {textAlign:"right"})}>Actions</th>
                </tr>
              </thead>
              <tbody>
                {filtered.length === 0 ? (
                  <tr><td colSpan={7}><div style={S.empty}>No certificates found</div></td></tr>
                ) : filtered.map(function(c) {
                  var needsRenewal = (c.status === "expiring_soon" || c.status === "expired") && !c.renewalSent;
                  return (
                    <tr key={c.id} style={{cursor:"pointer"}} onClick={function() { setVCert(c); }}
                      onMouseEnter={function(e) { e.currentTarget.style.background="#f8fafc"; }}
                      onMouseLeave={function(e) { e.currentTarget.style.background="transparent"; }}>
                      <td style={S.td}>
                        <div style={{fontWeight:600,color:"#1e293b"}}>{c.customer}</div>
                        <div style={{fontSize:12,color:"#94a3b8",marginTop:2}}>{c.id} / {c.ein}</div>
                        {c.email && <div style={{fontSize:11,color:"#6366f1",marginTop:1}}>{c.email}</div>}
                      </td>
                      <td style={S.td}>
                        <div style={{color:"#475569"}}>{c.reason}</div>
                        <div style={{fontSize:12,color:"#94a3b8"}}>{c.type}</div>
                      </td>
                      <td style={S.td}>
                        {c.states.slice(0,3).map(function(st) { return <span key={st} style={S.stg}>{st}</span>; })}
                        {c.states.length > 3 && <span style={{color:"#94a3b8",fontSize:11}}> +{c.states.length-3}</span>}
                      </td>
                      <td style={S.td}>
                        <div style={{color: c.daysLeft < 0 ? "#dc2626" : c.daysLeft < 90 ? "#d97706" : "#475569", fontWeight:600, fontSize:13}}>
                          {c.expDate}
                        </div>
                        <div style={{fontSize:11,color:"#94a3b8",marginTop:2}}>
                          {c.daysLeft < 0 ? Math.abs(c.daysLeft) + "d overdue" : c.daysLeft + "d remaining"}
                        </div>
                      </td>
                      <td style={S.td}><Badge status={c.status} /></td>
                      <td style={S.td} onClick={function(e) { e.stopPropagation(); }}>
                        {c.renewalSent ? (
                          <span style={S.sentBadge}>Sent</span>
                        ) : needsRenewal ? (
                          <button style={Object.assign({}, S.btn, S.btnG, {padding:"5px 12px",fontSize:12})} onClick={function() { sendRenewal(c); }}>
                            Send
                          </button>
                        ) : (
                          <span style={{fontSize:12,color:"#cbd5e1"}}>--</span>
                        )}
                      </td>
                      <td style={Object.assign({}, S.td, {textAlign:"right"})} onClick={function(e) { e.stopPropagation(); }}>
                        <button style={S.aBtn} onClick={function() { setVCert(c); }}>View</button>
                        <button style={S.aBtn} onClick={function() { openEdit(c); }}>Edit</button>
                        <button style={Object.assign({}, S.aBtn, {color:"#ef4444"})} onClick={function() { doDelete(c.id); }}>Del</button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
          <div style={S.tFoot}>Showing {filtered.length} of {enriched.length} certificates</div>
        </div>
      </div>

      {/* View Modal */}
      {vCert && (
        <div style={S.ov} onClick={closeAll}>
          <div style={Object.assign({}, S.mdl, S.mdlS)} onClick={function(e) { e.stopPropagation(); }}>
            <div style={S.mdlH}>
              <div>
                <div style={S.mdlT}>{vCert.customer}</div>
                <div style={{fontSize:13,color:"#94a3b8",marginTop:3}}>{vCert.id}</div>
              </div>
              <button style={S.xb} onClick={closeAll}>x</button>
            </div>
            <div style={{marginBottom:14,display:"flex",gap:8,alignItems:"center"}}>
              <Badge status={gSt(vCert.expDate)} />
              {vCert.renewalSent && <span style={S.sentBadge}>Renewal Sent</span>}
            </div>
            <div style={S.dgr}>
              <div><span style={S.dgl}>EIN: </span><span style={S.dgv}>{vCert.ein}</span></div>
              <div><span style={S.dgl}>Type: </span><span style={S.dgv}>{vCert.type}</span></div>
              <div><span style={S.dgl}>Reason: </span><span style={S.dgv}>{vCert.reason}</span></div>
              <div><span style={S.dgl}>Issued: </span><span style={S.dgv}>{vCert.issueDate}</span></div>
              <div><span style={S.dgl}>Expires: </span><span style={S.dgv}>{vCert.expDate}</span></div>
              <div>
                <span style={S.dgl}>Email: </span>
                <span style={{color: vCert.email ? "#4f46e5" : "#dc2626",marginLeft:4,fontSize:14}}>
                  {vCert.email || "Not on file"}
                </span>
              </div>
            </div>
            <div>
              <span style={S.dgl}>Jurisdictions:</span>
              <div style={{display:"flex",flexWrap:"wrap",gap:5,marginTop:6}}>
                {vCert.states.map(function(st) { return <span key={st} style={S.dst}>{st}</span>; })}
              </div>
            </div>
            {vCert.notes && (
              <div style={{marginTop:10}}>
                <span style={S.dgl}>Notes:</span>
                <div style={{color:"#475569",fontSize:14,marginTop:4}}>{vCert.notes}</div>
              </div>
            )}
            <div style={{display:"flex",gap:8,marginTop:18,flexWrap:"wrap"}}>
              <button style={Object.assign({}, S.btn, S.btnP, {flex:1,justifyContent:"center"})} onClick={function() { closeAll(); openEdit(vCert); }}>Edit</button>
              {vCert.email && (gSt(vCert.expDate) === "expiring_soon" || gSt(vCert.expDate) === "expired") && (
                <a href={generateMailto(Object.assign({}, vCert, {daysLeft: daysUntil(vCert.expDate)}))} style={Object.assign({}, S.btn, S.btnG, {flex:1,justifyContent:"center",textDecoration:"none"})}>
                  Open Renewal Email
                </a>
              )}
              <button style={Object.assign({}, S.btn, S.btnD, {flex:1,justifyContent:"center"})} onClick={function() { closeAll(); doDelete(vCert.id); }}>Delete</button>
            </div>
          </div>
        </div>
      )}

      {/* Form Modal */}
      {modal === "form" && (
        <div style={S.ov} onClick={closeAll}>
          <div style={Object.assign({}, S.mdl, S.mdlL)} onClick={function(e) { e.stopPropagation(); }}>
            <div style={S.mdlH}>
              <div style={S.mdlT}>{eId ? "Edit Certificate" : "New Exemption Certificate"}</div>
              <button style={S.xb} onClick={closeAll}>x</button>
            </div>
            <div style={S.fgr}>
              <div style={S.fld}>
                <label style={S.fla}>Customer Name</label>
                <input style={Object.assign({}, S.fin, fErr.customer ? S.finEr : {})} value={frm.customer} onChange={function(e) { updFld("customer",e.target.value); }} />
                {fErr.customer && <div style={S.fer}>{fErr.customer}</div>}
              </div>
              <div style={S.fld}>
                <label style={S.fla}>EIN / Tax ID</label>
                <input style={Object.assign({}, S.fin, fErr.ein ? S.finEr : {})} value={frm.ein} placeholder="XX-XXXXXXX" onChange={function(e) { updFld("ein",e.target.value); }} />
                {fErr.ein && <div style={S.fer}>{fErr.ein}</div>}
              </div>
              <div style={Object.assign({}, S.fld, {gridColumn:"1 / -1"})}>
                <label style={S.fla}>Customer Email (for renewal outreach)</label>
                <input style={Object.assign({}, S.fin, fErr.email ? S.finEr : {})} value={frm.email} placeholder="tax@company.com" type="email" onChange={function(e) { updFld("email",e.target.value); }} />
                {fErr.email && <div style={S.fer}>{fErr.email}</div>}
                <div style={{fontSize:11,color:"#94a3b8",marginTop:2}}>We will use this email to send renewal requests 90 days before expiration.</div>
              </div>
              <div style={S.fld}>
                <label style={S.fla}>Certificate Type</label>
                <select style={S.fin} value={frm.type} onChange={function(e) { updFld("type",e.target.value); }}>
                  {CTYPES.map(function(t) { return <option key={t} value={t}>{t}</option>; })}
                </select>
              </div>
              <div style={S.fld}>
                <label style={S.fla}>Exemption Reason</label>
                <select style={S.fin} value={frm.reason} onChange={function(e) { updFld("reason",e.target.value); }}>
                  {REASONS.map(function(r) { return <option key={r} value={r}>{r}</option>; })}
                </select>
              </div>
              <div style={S.fld}>
                <label style={S.fla}>Issue Date</label>
                <input type="date" style={Object.assign({}, S.fin, fErr.issueDate ? S.finEr : {})} value={frm.issueDate} onChange={function(e) { updFld("issueDate",e.target.value); }} />
                {fErr.issueDate && <div style={S.fer}>{fErr.issueDate}</div>}
              </div>
              <div style={S.fld}>
                <label style={S.fla}>Expiration Date</label>
                <input type="date" style={Object.assign({}, S.fin, fErr.expDate ? S.finEr : {})} value={frm.expDate} onChange={function(e) { updFld("expDate",e.target.value); }} />
                {fErr.expDate && <div style={S.fer}>{fErr.expDate}</div>}
              </div>
            </div>
            <div style={Object.assign({}, S.fld, {marginBottom:14})}>
              <label style={S.fla}>Jurisdictions</label>
              <div style={Object.assign({}, S.sgr, fErr.states ? {borderColor:"#f87171"} : {})}>
                {ALLST.map(function(st) {
                  var sel = frm.states.indexOf(st) >= 0;
                  return <button key={st} style={Object.assign({}, S.sb, sel ? S.sbOn : {})} onClick={function() { toggleSt(st); }}>{st}</button>;
                })}
              </div>
              {fErr.states && <div style={S.fer}>{fErr.states}</div>}
            </div>
            <div style={S.fld}>
              <label style={S.fla}>Notes</label>
              <textarea style={Object.assign({}, S.fin, {resize:"none",height:56})} value={frm.notes} onChange={function(e) { updFld("notes",e.target.value); }} />
            </div>
            <div style={{display:"flex",gap:10,marginTop:18}}>
              <button style={Object.assign({}, S.btn, S.btnP, {flex:1,justifyContent:"center"})} onClick={doSubmit}>{eId ? "Update" : "Save"} Certificate</button>
              <button style={Object.assign({}, S.btn, S.btnS)} onClick={closeAll}>Cancel</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
